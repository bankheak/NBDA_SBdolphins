dim(event_data)
dim(edge_list)
dim(t_weights_dynamic)
event_data_2
networks
networks <- data.frame(
trial = 1,
focal = c("A", "A", "B",
"A", "A", "B",
"A", "A", "B"),
other = c("B", "C", "C",
"B", "C", "C",
"B", "C", "C"),
foveation = c(1, 0, 1, #summarizes from start of obs period to first event
0, 1, 1, #summarizes from first event to second event
0, 0, 1), #summarizes from second event to final event,
time = rep(1:3, each=3)
)
# Test data
event_data_2 <- data.frame(
trial = rep(1:2, each = 3),
id = LETTERS[1:6],
time = c(2, 1, 3, 4, 2, 1),
t_end = c(3, 3, 3, 4, 4, 4)
)
networks <- data.frame(
trial = 1,
focal = c("A", "A", "B",
"A", "A", "B",
"A", "A", "B"),
other = c("B", "C", "C",
"B", "C", "C",
"B", "C", "C"),
foveation = c(1, 0, 1, #summarizes from start of obs period to first event
0, 1, 1, #summarizes from first event to second event
0, 0, 1), #summarizes from second event to final event,
time = rep(1:3, each=3)
)
t_weights_dynamic_2 <- data.frame(
trial = c(rep(1, each = 9),rep(2, each = 9)),
id = c(rep(LETTERS[1:3], each=3), rep(LETTERS[4:6], each=3)),
time = c(rep(1:3, times = 3), rep(1:3, times=3)),
t_weight = rbeta(18, 1, 5)
)
data_list <- import_user_STb(
event_data = event_data_2,
networks = networks,
t_weights = t_weights_dynamic_2
)
View(event_data)
# Change event data to be dynamic
event_data_dynamic <- data.frame(trail = 1, id = rep(ILV_all$Alias, each = 20),
time = ifelse(is.na(ILV_all$HI_Order_acquisition),
max(na.omit(ILV_all$HI_Order_acquisition)) + 1,
ILV_all$HI_Order_acquisition),
t_end = max(na.omit(ILV_all$HI_Order_acquisition)))
View(event_data_dynamic)
# Change event data to be dynamic
event_data_dynamic <- data.frame(trail = 1, id = rep(ILV_all$Alias, each = 20),
time = rep(ifelse(is.na(ILV_all$HI_Order_acquisition),
max(na.omit(ILV_all$HI_Order_acquisition)) + 1,
ILV_all$HI_Order_acquisition), each = 20),
t_end = max(na.omit(ILV_all$HI_Order_acquisition)))
# Input data
data_list <- import_user_STb(
event_data = event_data,
networks = edge_list,
ILV_c = ILV_sex,
ILV_tv = ILV_age,
ILVi = c("age"),
ILVs = c("sex"),
t_weights = t_weights_dynamic
)
# Input data
data_list <- import_user_STb(
event_data = event_data_dynamic,
networks = edge_list,
ILV_c = ILV_sex,
ILV_tv = ILV_age,
ILVi = c("age"),
ILVs = c("sex"),
t_weights = t_weights_dynamic
)
# Change event data to be dynamic
event_data_dynamic <- data.frame(trial = 1, id = rep(ILV_all$Alias, each = 20),
time = rep(ifelse(is.na(ILV_all$HI_Order_acquisition),
max(na.omit(ILV_all$HI_Order_acquisition)) + 1,
ILV_all$HI_Order_acquisition), each = 20),
t_end = max(na.omit(ILV_all$HI_Order_acquisition)))
# Input data
data_list <- import_user_STb(
event_data = event_data_dynamic,
networks = edge_list,
ILV_c = ILV_sex,
ILV_tv = ILV_age,
ILVi = c("age"),
ILVs = c("sex"),
t_weights = t_weights_dynamic
)
View(edge_list)
View(nxn)
# Input data
data_list <- import_user_STb(
event_data = event_data_dynamic,
networks = edge_list,
ILV_c = ILV_sex,
ILV_tv = ILV_age,
ILVi = c("age"),
ILVs = c("sex")
)
# Input data
data_list <- import_user_STb(
event_data = event_data_dynamic,
networks = edge_list,
ILV_c = ILV_sex,
ILV_tv = ILV_age,
ILVi = c("age"),
ILVs = c("sex"),
t_weights = t_weights_dynamic
)
# Step 1: Merge focal weights
edge_weights <- merge(edge_list, t_weights_dynamic,
by.x = c("trial", "focal"),
by.y = c("trial", "id"),
all.x = TRUE)
names(edge_weights)[names(edge_weights) == "t_weight"] <- "focal_weight"
View(edge_weights)
# Step 2: Merge other weights
edge_weights <- merge(edge_weights, t_weights_dynamic,
by.x = c("trial", "other", "time"),
by.y = c("trial", "id", "time"),
all.x = TRUE)
View(edge_list)
View(t_weights_dynamic)
# Step 1: Merge focal weights
edge_weights <- merge(edge_list, t_weights_dynamic,
by.x = c("trial", "focal", "time"),
by.y = c("trial", "id", "time"),
all.x = TRUE)
names(edge_weights)[names(edge_weights) == "t_weight"] <- "focal_weight"
View(edge_weights)
# Step 2: Merge other weights
edge_weights <- merge(edge_weights, t_weights_dynamic,
by.x = c("trial", "other", "time"),
by.y = c("trial", "id", "time"),
all.x = TRUE)
names(edge_weights)[names(edge_weights) == "t_weight"] <- "other_weight"
# Step 3: Compute combined weight
edge_weights$weight <- rowMeans(cbind(edge_weights$focal_weight,
edge_weights$other_weight), na.rm = TRUE)
# Step 4: Keep only needed columns
edge_weights <- c["trial", "focal", "other", "assoc", "weight"]
# Step 4: Keep only needed columns
edge_weights <- c[c("trial", "focal", "other", "assoc", "weight")]
# Step 4: Keep only needed columns
edge_weights <- c[, c("trial", "focal", "other", "assoc", "weight")]
# Step 4: Keep only needed columns
edge_weights <- edge_weights[, c("trial", "focal", "other", "assoc", "weight")]
# Step 1: Merge focal weights
edge_weights <- merge(edge_list, t_weights_dynamic,
by.x = c("trial", "focal", "time"),
by.y = c("trial", "id", "time"),
all.x = TRUE)
names(edge_weights)[names(edge_weights) == "t_weight"] <- "focal_weight"
# Step 2: Merge other weights
edge_weights <- merge(edge_weights, t_weights_dynamic,
by.x = c("trial", "other", "time"),
by.y = c("trial", "id", "time"),
all.x = TRUE)
names(edge_weights)[names(edge_weights) == "t_weight"] <- "other_weight"
# Step 3: Compute combined weight
edge_weights$weight <- rowMeans(cbind(edge_weights$focal_weight,
edge_weights$other_weight), na.rm = TRUE)
# Step 4: Keep only needed columns
weights_dynamic <- edge_weights[, c("trial", "focal", "other", "weight")]
# Input data
data_list <- import_user_STb(
event_data = event_data,
networks = edge_list,
ILV_c = ILV_sex,
ILV_tv = ILV_age,
ILVi = c("age"),
ILVs = c("sex"),
t_weights = weights_dynamic
)
View(weights_dynamic)
View(edge_list)
# Step 4: Keep only needed columns
weights_dynamic <- edge_weights[, c("focal", "other", "trial", "weight")]
View(edge_weights)
# Step 4: Keep only needed columns
weights_dynamic <- edge_weights[, c("focal", "other", "trial", "weight", "time")]
# Input data
data_list <- import_user_STb(
event_data = event_data,
networks = edge_list,
ILV_c = ILV_sex,
ILV_tv = ILV_age,
ILVi = c("age"),
ILVs = c("sex"),
t_weights = weights_dynamic
)
length(edge_list$focal %in% weights_dynamic$focal)
# Step 1: Merge focal weights
edge_weights <- merge(edge_list, t_weights_dynamic,
by.x = c("trial", "focal"),
by.y = c("trial", "id"),
all.x = TRUE)
names(edge_weights)[names(edge_weights) == "t_weight"] <- "focal_weight"
View(edge_weights)
# Step 2: Merge other weights
edge_weights <- merge(edge_weights, t_weights_dynamic,
by.x = c("trial", "other", "time.x"),
by.y = c("trial", "id", "time.y"),
all.x = TRUE)
# Step 2: Merge other weights
edge_weights <- merge(edge_weights, t_weights_dynamic,
by.x = c("trial", "other", "time"),
by.y = c("trial", "id", "time"),
all.x = TRUE)
# Get all unique times from t_weights_dynamic
times <- sort(unique(t_weights_dynamic$time))
# Expand edge_list for all time points
edge_expanded <- edge_list[rep(seq_len(nrow(edge_list)), each = length(times)), ]
edge_expanded
edge_expanded$time <- rep(times, times = nrow(edge_list))
# Step 1: Merge focal weights
edge_weights <- merge(edge_expanded, t_weights_dynamic,
by.x = c("trial", "focal", "time"),
by.y = c("trial", "id", "time"),
all.x = TRUE)
names(edge_weights)[names(edge_weights) == "t_weight"] <- "focal_weight"
# Step 2: Merge other weights
edge_weights <- merge(edge_weights, t_weights_dynamic,
by.x = c("trial", "other", "time"),
by.y = c("trial", "id", "time"),
all.x = TRUE)
names(edge_weights)[names(edge_weights) == "t_weight"] <- "other_weight"
# Compute combined weight
edge_weights$weight <- rowMeans(cbind(edge_weights$focal_weight,
edge_weights$other_weight), na.rm = TRUE)
# Keep only needed columns
weights_dynamic <- edge_weights[, c("focal", "other", "trial", "weight", "time")]
View(weights_dynamic)
View(edge_weights)
# Get all unique times from t_weights_dynamic
times <- sort(unique(t_weights_dynamic$time))
# Expand edge_list for all time points
edge_expanded <- edge_list[rep(seq_len(nrow(edge_list)), each = length(times)), ]
edge_expanded$time <- rep(times, times = nrow(edge_list))
# Step 1: Merge focal weights
edge_weights <- merge(edge_expanded, t_weights_dynamic,
by.x = c("trial", "focal", "time"),
by.y = c("trial", "id", "time"),
all.x = TRUE)
names(edge_weights)[names(edge_weights) == "t_weight"] <- "focal_weight"
# Expand edge_list for all time points
edge_expanded <- edge_list[rep(seq_len(nrow(edge_list)), each = length(times)), ]
View(edge_expanded)
View(edge_list)
seq_len(nrow(edge_list)
)
View(HI_matrix)
as.vector(t(HI_matrix))
# Order edge data
edge_list <- edge_list[order(edge_list$focal), ]
# Order edge data
edge_list <- edge_list[order(edge_list$time), ]
length(edge_list$time == 1)
str(edge_list)
unique(edge_list$time)
sum(edge_list$time == 1)
sum(edge_list$time == 2)
sum(edge_list$focal == "F102")
sum(edge_list$focal == "F110")
# Read in all network data
nxn <- readRDS("nxn.RData")
# Subset nxn
nxn <- nxn[3:22]
# Get the intersection of row names across all matrices
common_names <- Reduce(intersect, lapply(nxn, rownames))
# Subset each matrix to include only those common names
for (i in seq_along(nxn)) {
nxn[[i]] <- nxn[[i]][common_names, common_names, drop = FALSE]
}
View(nxn)
# Prepare random effect for MCMC
num_nodes <- lapply(nxn, function(df) dim(df)[1])
num_nodes
node_names <- lapply(nxn, function(df) colnames(df))
node_names
# Separate IDs into i and j
node_ids_i <- lapply(num_nodes, function(df) matrix(rep(1:df, each = df), nrow = df, ncol = df))
node_ids_j <- lapply(node_ids_i, function(df) t(df))
View(node_ids_i)
node_ids_i[[1]]
View(node_ids_j)
node_ids_j[[1]]
# Abind nxn
upper_tri <- lapply(nxn, function(df) upper.tri(df, diag = TRUE))
edge_nxn <- abind(lapply(nxn, function(mat) mat[upper.tri(mat, diag = TRUE)]), along = 2)
View(edge_nxn)
# Create the edge_list
n_mats <- ncol(edge_nxn)
n_edges <- nrow(edge_nxn)
# Flatten all values
values <- as.vector(edge_nxn)
# Create group labels (1 to n_mats repeated for each row)
groups <- rep(1:n_mats, each = n_edges)
# Combine into a data frame
edge_data <- data.frame(value = values, group = groups)
one <- lapply(seq_along(node_ids_i), function(i) factor(as.vector(node_names[[i]][node_ids_i[[i]][upper_tri[[i]]]]), levels = node_names[[i]]))
two <- lapply(seq_along(node_ids_j), function(i) factor(as.vector(node_names[[i]][node_ids_j[[i]][upper_tri[[i]]]]), levels = node_names[[i]]))
# Create the edge_list
edge_list = data.frame(focal = unlist(one),
other = unlist(two),
trial = 1,
assoc = edge_data[, 1],
time = edge_data[, 2])
View(edge_list)
View(HI_matrix)
View(prob_HI)
View(prob_HI[[1]])
# Add transmission weights
t_weights_dynamic <- data.frame(
trial = 1,
focal = edge_list$focal,
other = edge_list$other,
time = edge_list$time,
t_weight = mapply(function(focal_id, year) HI_matrix[focal_id, year],
edge_list$focal, edge_list$time)
)
View(t_weights_dynamic)
# Input data
data_list <- import_user_STb(
event_data = event_data,
networks = edge_list,
ILV_c = ILV_sex,
ILV_tv = ILV_age,
ILVi = c("age"),
ILVs = c("sex"),
t_weights = weights_dynamic
)
# Input data
data_list <- import_user_STb(
event_data = event_data,
networks = edge_list,
ILV_c = ILV_sex,
ILV_tv = ILV_age,
ILVi = c("age"),
ILVs = c("sex"),
t_weights = t_weights_dynamic
)
event_data
edge_list
t_weights_dynamic
?import_user_STb
t_weights_dynamic <- data.frame(
trial = c(rep(1, each = 9),rep(2, each = 9)),
id = c(rep(LETTERS[1:3], each=3), rep(LETTERS[4:6], each=3)),
time = c(rep(1:3, times = 3), rep(1:3, times=3)),
t_weight = rbeta(18, 1, 5)
)
View(t_weights_dynamic_2)
View(t_weights_dynamic)
rep(c(1:20), each = length(event_data$id))
rep(c(1:20), times = length(event_data$id))
as.vector(t(HI_matrix))
# Add transmission weights
t_weights_dynamic <- data.frame(
trial = 1,
id = event_data$id,
time = rep(c(1:20), times = length(event_data$id)),
t_weight = as.vector(t(HI_matrix))
)
View(t_weights_dynamic_2)
# Input data
data_list <- import_user_STb(
event_data = event_data,
networks = edge_list,
ILV_c = ILV_sex,
ILV_tv = ILV_age,
ILVi = c("age"),
ILVs = c("sex"),
t_weights = t_weights_dynamic
)
networks <- data.frame(
trial = 1,
focal = c("A", "A", "B",
"A", "A", "B",
"A", "A", "B"),
other = c("B", "C", "C",
"B", "C", "C",
"B", "C", "C"),
foveation = c(1, 0, 1, #summarizes from start of obs period to first event
0, 1, 1, #summarizes from first event to second event
0, 0, 1), #summarizes from second event to final event,
time = rep(1:3, each=3)
)
View(networks)
# Constant ILVs
ILV_c <- data.frame(id = ILV_all$Alias,
age = ILV_all$Sex)
# Time varying ILVs
ILV_tv <- data.frame(
trial = 1,
id = rep(ILV_all$Alias, each = 20),
time = rep(1:20, times = length(ILV_all$Alias)),
year = rep(1995:2014, times = length(ILV_all$Alias)),
age = rep(1995:2014, times = length(ILV_all$Alias)) -
rep(ILV_all$BirthYear, each = 20)
)
View(ILV_tv)
# Add transmission weights
ILV_tv$weight <- as.vector(t(HI_matrix))
# Input data
data_list <- import_user_STb(
event_data = event_data,
networks = edge_list,
ILV_c = ILV_c,
ILV_tv = ILV_tv,
ILVi = c("age", "weight"),
ILVs = c("sex")
)
model = generate_STb_model(data_list,
veff_params = c("lambda_0", "s"),
veff_type="id") #on id
# Generate the model
model_full <- generate_STb_model(data_list, gq = T, est_acqTime = T)
?generate_STb_model
# Input data
data_list <- import_user_STb(
event_data = event_data,
networks = edge_list,
ILV_c = ILV_c,
ILV_tv = ILV_tv,
ILVi = c("age"),
ILVs = c("sex")
)
# Generate the model
model_full <- generate_STb_model(data_list, gq = T, est_acqTime = T)
data_list <- import_user_STb(
event_data = event_data,
networks = edge_list
)
# Generate the model
model_full <- generate_STb_model(data_list, gq = T, est_acqTime = T)
# Fit the model
full_fit <- fit_STb(data_list,
model_full,
parallel_chains = 4,
chains = 4,
cores = 4,
iter = 2000,
refresh=1000
)
library(cmdstanr)
install_cmdstan()
cmdstanr::check_cmdstan_toolchain(fix = TRUE)
# Fit the model
full_fit <- fit_STb(data_list,
model_full,
parallel_chains = 4,
chains = 4,
cores = 4,
iter = 2000,
refresh=1000
)
set_cmdstan_path("/path/to/cmdstan")
cmdstan_path()
set_cmdstan_path()
?set_cmdstan_path()
set_cmdstan_path(path = NULL)
library(cmdstanr)
cmdstan_path()
set_cmdstan_path("~/.cmdstan/cmdstan-2.35.0")  # Example version
cmdstanr::cmdstan_version()
cmdstan_path()
install.packages("CmdStan")
install.packages("remotes")
library(cmdstanr)
# Fit the model
full_fit <- fit_STb(data_list,
model_full,
parallel_chains = 4,
chains = 4,
cores = 4,
iter = 2000,
refresh=1000
)
if(!require(tidyr)){install.packages('tidyr'); library(tidyr)} # array
if(!require(abind)){install.packages('abind'); library(abind)} # array
if(!require(STbayes)){install.packages('STbayes'); library(STbayes)}
if(!require(ggplot2)){install.packages('ggplot2'); library(ggplot2)}
if(!require(dplyr)){install.packages('dplyr'); library(dplyr)}
if(!require(posterior)){install.packages('posterior'); library(posterior)}
## Creating networks
if(!require(asnipe)){install.packages('asnipe'); library(asnipe)} # get_group_by_individual
if(!require(sf)){install.packages('sf'); library(sf)} # Convert degrees to meters
if(!require(sp)){install.packages('sp'); library(sp)} # Convert degrees to meters
if(!require(adehabitatHR)){install.packages('adehabitatHR'); library(adehabitatHR)} # Caluculate MCPs and Kernel density
if(!require(kinship2)){install.packages('kinship2'); library(kinship2)} # genetic relatedness
# Fit the model
full_fit <- fit_STb(data_list,
model_full,
parallel_chains = 4,
chains = 4,
cores = 4,
iter = 2000,
refresh=1000
)
install_cmdstan()
